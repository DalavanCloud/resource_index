require_relative 'test_case'

DIRECT = [2466199616, 3984536638, 2631822857, 4272574507, 1514996459, 2974317510, 2604095094, 425808451, 1336324502, 1256174170, 2783506253, 1765934245, 3152067627, 2588657372, 4259096489, 516089123, 30093454, 3116223171, 2011060733, 2936938335]
DIRECT_COUNT = {2466199616=>2, 3984536638=>4, 2631822857=>1, 4272574507=>1, 1514996459=>2, 2974317510=>22, 2604095094=>1, 425808451=>16, 1336324502=>14, 1256174170=>1, 2783506253=>1, 1765934245=>1, 3152067627=>6, 2588657372=>3, 4259096489=>75, 516089123=>1, 30093454=>1, 3116223171=>12, 2011060733=>58, 2936938335=>1}
DIRECT_DOCS = {2466199616=>["E-GEOD-32422", "E-GEOD-40205"], 3984536638=>["E-GEOD-27302", "E-GEOD-41986", "E-GEOD-42140", "E-GEOD-43307"], 2631822857=>["E-BAIR-1"], 4272574507=>["E-MEXP-3350"], 1514996459=>["E-GEOD-32422", "E-GEOD-43307"], 2974317510=>["E-ERAD-61", "E-GEOD-28471", "E-GEOD-33272", "E-GEOD-33273", "E-GEOD-33341", "E-GEOD-34643", "E-GEOD-34844", "E-GEOD-35179", "E-GEOD-38168", "E-GEOD-39976", "E-GEOD-40366", "E-GEOD-41986", "E-GEOD-42865", "E-GEOD-43177", "E-GEOD-43178", "E-GEOD-43373", "E-GEOD-43484", "E-GEOD-43497", "E-GEOD-43517", "E-GEOD-43553", "E-MTAB-1044", "E-TABM-7"], 2604095094=>["E-GEOD-32422"], 425808451=>["E-GEOD-22087", "E-GEOD-34923", "E-GEOD-37386", "E-GEOD-38110", "E-GEOD-38169", "E-GEOD-38210", "E-GEOD-38211", "E-GEOD-41561", "E-GEOD-42462", "E-GEOD-42551", "E-GEOD-42701", "E-GEOD-42880", "E-GEOD-43287", "E-GEOD-43581", "E-GEOD-43595", "E-MTAB-1371"], 1336324502=>["E-GEOD-35493", "E-GEOD-35843", "E-GEOD-36596", "E-GEOD-37136", "E-GEOD-37842", "E-GEOD-42798", "E-GEOD-42799", "E-GEOD-43324", "E-GEOD-43403", "E-GEOD-43441", "E-GEOD-43464", "E-MEXP-3542", "E-MTAB-1328", "E-SMDB-4088"], 1256174170=>["E-GEOD-39918"], 2783506253=>["E-GEOD-43548"], 1765934245=>["E-GEOD-43465"], 3152067627=>["E-GEOD-26749", "E-GEOD-26750", "E-GEOD-35309", "E-GEOD-39918", "E-GEOD-42912", "E-GEOD-43441"], 2588657372=>["E-GEOD-41331", "E-GEOD-41336", "E-GEOD-43324"], 4259096489=>["E-BAIR-10", "E-BAIR-11", "E-BAIR-12", "E-BAIR-9", "E-ERAD-69", "E-GEOD-13214", "E-GEOD-13561", "E-GEOD-16035", "E-GEOD-23435", "E-GEOD-26600", "E-GEOD-29365", "E-GEOD-29767", "E-GEOD-31030", "E-GEOD-31466", "E-GEOD-32868", "E-GEOD-32934", "E-GEOD-33217", "E-GEOD-33271", "E-GEOD-34119", "E-GEOD-35179", "E-GEOD-35309", "E-GEOD-35493", "E-GEOD-35843", "E-GEOD-37653", "E-GEOD-38228", "E-GEOD-38463", "E-GEOD-38651", "E-GEOD-38756", "E-GEOD-38757", "E-GEOD-38758", "E-GEOD-38759", "E-GEOD-38760", "E-GEOD-38995", "E-GEOD-39159", "E-GEOD-39334", "E-GEOD-39521", "E-GEOD-39998", "E-GEOD-41232", "E-GEOD-41688", "E-GEOD-41776", "E-GEOD-41777", "E-GEOD-42544", "E-GEOD-42701", "E-GEOD-42861", "E-GEOD-42936", "E-GEOD-43282", "E-GEOD-43290", "E-GEOD-43315", "E-GEOD-43324", "E-GEOD-43351", "E-GEOD-43363", "E-GEOD-43407", "E-GEOD-43441", "E-GEOD-43468", "E-GEOD-43469", "E-GEOD-43476", "E-GEOD-43496", "E-GEOD-43548", "E-GEOD-43581", "E-GEOD-43603", "E-GEOD-43621", "E-GEOD-43630", "E-GEOD-43651", "E-LGCL-2", "E-LGCL-3", "E-MEXP-32", "E-MEXP-3657", "E-MIMR-17", "E-MTAB-1044", "E-MTAB-1245", "E-MTAB-1432", "E-SMDB-23", "E-SNGR-9", "E-TIGR-105", "E-TIGR-106"], 516089123=>["E-GEOD-39174"], 30093454=>["E-ERAD-145"], 3116223171=>["E-GEOD-33073", "E-GEOD-33074", "E-GEOD-34643", "E-GEOD-35179", "E-GEOD-37842", "E-GEOD-42865", "E-GEOD-43315", "E-GEOD-43484", "E-GEOD-43630", "E-LGCL-2", "E-LGCL-3", "E-SMDB-3690"], 2011060733=>["E-ERAD-144", "E-ERAD-56", "E-ERAD-59", "E-ERAD-67", "E-ERAD-68", "E-ERAD-92", "E-GEOD-14995", "E-GEOD-15654", "E-GEOD-22087", "E-GEOD-25609", "E-GEOD-26600", "E-GEOD-27237", "E-GEOD-27916", "E-GEOD-31030", "E-GEOD-32868", "E-GEOD-32934", "E-GEOD-34977", "E-GEOD-35039", "E-GEOD-35710", "E-GEOD-36596", "E-GEOD-37136", "E-GEOD-38045", "E-GEOD-38228", "E-GEOD-38756", "E-GEOD-38757", "E-GEOD-38758", "E-GEOD-38759", "E-GEOD-38760", "E-GEOD-38994", "E-GEOD-39150", "E-GEOD-39976", "E-GEOD-40722", "E-GEOD-41232", "E-GEOD-41776", "E-GEOD-41777", "E-GEOD-42259", "E-GEOD-42260", "E-GEOD-42261", "E-GEOD-42880", "E-GEOD-42952", "E-GEOD-43282", "E-GEOD-43300", "E-GEOD-43315", "E-GEOD-43370", "E-GEOD-43410", "E-GEOD-43445", "E-GEOD-43464", "E-GEOD-43471", "E-GEOD-43476", "E-GEOD-43517", "E-GEOD-43535", "E-GEOD-43548", "E-MIMR-7", "E-MTAB-1049", "E-MTAB-1090", "E-MTAB-1217", "E-MTAB-1328", "E-MTAB-840"], 2936938335=>["E-GEOD-43282"]}
ANCESTOR = [1451753496, 1962416293, 4218785817, 2734229646, 1345681999, 3711642197, 112084953, 2327289691, 3417860480, 1198453896, 4126637963, 4015180667, 2803327913, 2273602499, 2196291566, 2195037458, 3378637605, 1597457097, 1379944859, 1008773520]
ANCESTOR_COUNT = {1451753496=>11, 1962416293=>3, 4218785817=>3, 2734229646=>131, 1345681999=>1, 3711642197=>1, 112084953=>1, 2327289691=>1, 3417860480=>1, 1198453896=>1, 4126637963=>7, 4015180667=>3, 2803327913=>1, 2273602499=>2, 2196291566=>1, 2195037458=>1, 3378637605=>2, 1597457097=>2, 1379944859=>2, 1008773520=>4}
ANCESTOR_DOCS = {1451753496=>["E-BAIR-1", "E-BAIR-10", "E-BAIR-11", "E-BAIR-12", "E-BAIR-8", "E-BAIR-9", "E-GEOD-32934", "E-GEOD-38995", "E-GEOD-43581", "E-MIMR-42", "E-SMDB-6"], 1962416293=>["E-GEOD-43255", "E-GEOD-43570", "E-MEXP-3723"], 4218785817=>["E-GEOD-41331", "E-GEOD-41336", "E-GEOD-41341"], 2734229646=>["E-ERAD-139", "E-ERAD-48", "E-ERAD-52", "E-ERAD-59", "E-ERAD-92", "E-GEOD-13214", "E-GEOD-13561", "E-GEOD-16035", "E-GEOD-25609", "E-GEOD-26586", "E-GEOD-26600", "E-GEOD-26751", "E-GEOD-27237", "E-GEOD-27302", "E-GEOD-27916", "E-GEOD-28471", "E-GEOD-29767", "E-GEOD-31030", "E-GEOD-33341", "E-GEOD-34132", "E-GEOD-34845", "E-GEOD-34977", "E-GEOD-35051", "E-GEOD-35179", "E-GEOD-35493", "E-GEOD-35710", "E-GEOD-35843", "E-GEOD-36596", "E-GEOD-37386", "E-GEOD-37653", "E-GEOD-37712", "E-GEOD-37713", "E-GEOD-37714", "E-GEOD-38200", "E-GEOD-38210", "E-GEOD-38211", "E-GEOD-38212", "E-GEOD-38230", "E-GEOD-38371", "E-GEOD-38377", "E-GEOD-38379", "E-GEOD-38761", "E-GEOD-38972", "E-GEOD-39058", "E-GEOD-39104", "E-GEOD-39150", "E-GEOD-39270", "E-GEOD-39323", "E-GEOD-39842", "E-GEOD-39918", "E-GEOD-40116", "E-GEOD-40126", "E-GEOD-40205", "E-GEOD-40739", "E-GEOD-40767", "E-GEOD-41188", "E-GEOD-41192", "E-GEOD-41193", "E-GEOD-41331", "E-GEOD-41336", "E-GEOD-41341", "E-GEOD-41383", "E-GEOD-41561", "E-GEOD-41677", "E-GEOD-41691", "E-GEOD-41937", "E-GEOD-42140", "E-GEOD-42261", "E-GEOD-42454", "E-GEOD-42576", "E-GEOD-42577", "E-GEOD-42655", "E-GEOD-42669", "E-GEOD-42670", "E-GEOD-42800", "E-GEOD-42880", "E-GEOD-42952", "E-GEOD-43179", "E-GEOD-43255", "E-GEOD-43272", "E-GEOD-43282", "E-GEOD-43300", "E-GEOD-43310", "E-GEOD-43324", "E-GEOD-43325", "E-GEOD-43333", "E-GEOD-43363", "E-GEOD-43377", "E-GEOD-43407", "E-GEOD-43410", "E-GEOD-43433", "E-GEOD-43446", "E-GEOD-43464", "E-GEOD-43472", "E-GEOD-43476", "E-GEOD-43482", "E-GEOD-43487", "E-GEOD-43492", "E-GEOD-43494", "E-GEOD-43497", "E-GEOD-43508", "E-GEOD-43512", "E-GEOD-43517", "E-GEOD-43547", "E-GEOD-43567", "E-GEOD-43582", "E-GEOD-43607", "E-GEOD-43608", "E-GEOD-43634", "E-GEOD-43635", "E-GEOD-43636", "E-GEOD-43639", "E-GEOD-43645", "E-GEOD-43669", "E-MEXP-32", "E-MEXP-3509", "E-MEXP-3662", "E-MTAB-1044", "E-MTAB-1093", "E-MTAB-1432", "E-MTAB-1433", "E-MTAB-1436", "E-MTAB-960", "E-SMDB-15", "E-SMDB-23", "E-SMDB-2855", "E-SMDB-4088", "E-SNGR-8", "E-TABM-7", "E-TABM-86", "E-TIGR-135"], 1345681999=>["E-MTAB-964"], 3711642197=>["E-GEOD-43598"], 112084953=>["E-GEOD-43611"], 2327289691=>["E-GEOD-39918"], 3417860480=>["E-GEOD-43517"], 1198453896=>["E-GEOD-43255"], 4126637963=>["E-GEOD-15654", "E-GEOD-33341", "E-GEOD-37040", "E-GEOD-37136", "E-GEOD-37842", "E-GEOD-39976", "E-MTAB-1049"], 4015180667=>["E-ERAD-92", "E-GEOD-41383", "E-GEOD-43569"], 2803327913=>["E-ERAD-60"], 2273602499=>["E-GEOD-37712", "E-GEOD-42867"], 2196291566=>["E-GEOD-43570"], 2195037458=>["E-MEXP-3509"], 3378637605=>["E-GEOD-32175", "E-GEOD-42880"], 1597457097=>["E-GEOD-39174", "E-GEOD-42912"], 1379944859=>["E-BASE-1", "E-GEOD-43373"], 1008773520=>["E-GEOD-43535", "E-GEOD-43588", "E-SMDB-15", "E-SMDB-8"]}

class RI::TestQueries < RI::TestCase
  def test_query
    res = RI::Resource.find("AE_test")
    mgrep = MockMGREPClient.new
    populator = RI::Population::Manager.new(res, mgrep_client: mgrep, bulk_index_size: 500)
    @es = RI.es # triggers delete on teardown
    @index_id = populator.populate()
    sleep(2) # wait for indexing to complete

    ##
    # Test counts
    DIRECT.each do |id|
      assert_equal DIRECT_COUNT[id], res.concept_count(id)
    end

    ANCESTOR.each do |id|
      assert_equal ANCESTOR_COUNT[id], res.concept_count(id, expand: true)
    end

    ##
    # Test returned documents
    DIRECT.each do |id|
      docs = res.concept_docs(id, size: 500).map {|d| d.id}.sort
      assert_equal DIRECT_DOCS[id].sort, docs
    end

    ANCESTOR.each do |id|
      docs = res.concept_docs(id, expand: true, size: 500).map {|d| d.id}.sort
      assert_equal ANCESTOR_DOCS[id].sort, docs
    end

    ##
    # Test multiple classes in a single doc (via AND)
    hashes = [1514996459, 2466199616]
    docs = res.es_concept_docs(hashes)
    assert_equal 1, docs.length
    assert_equal "E-GEOD-32422", docs.first["_id"]

    hashes = [1514996459, 2466199616, 2604095094]
    docs = res.es_concept_docs(hashes)
    assert_equal 1, docs.length
    assert_equal "E-GEOD-32422", docs.first["_id"]

    hashes = [2588657372, 4218785817, 2734229646]
    docs = res.es_concept_docs(hashes, expand: true)
    assert_equal 2, docs.length
    assert_equal ["E-GEOD-41336", "E-GEOD-41331"].sort, docs.map {|d| d["_id"]}.sort

    ##
    # Test multiple classes in a single doc (via OR)
    hashes = [2466199616, 2631822857]
    docs = res.es_concept_docs(hashes, bool: :should)
    assert_equal 3, docs.length
    assert_equal ["E-GEOD-32422", "E-GEOD-40205", "E-BAIR-1"].sort, docs.map {|d| d["_id"]}.sort

    ##
    # Pass bad options to count query (should still work)
    hashes = [1514996459, 2466199616]
    count = res.es_concept_count(hashes, size: 50, from: 0)
    assert_equal 1, count
  end
end